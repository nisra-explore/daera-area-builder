<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Rural Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="icon" type="image" href="img/favicon-daera.svg">

    <!-- imports for bootstrap - jquery and popper are dependencies -->
    <script src="https://cdn.jsdelivr.net/gh/jquery/jquery@3.4.1/dist/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/twbs/bootstrap@v4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/FezVrasta/popper.js@v1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/twbs/bootstrap@v4.5.2/dist/js/bootstrap.min.js"></script>

    <!-- fontawesome import -->
    <script src="https://kit.fontawesome.com/ee3848f0f5.js" crossorigin="anonymous"></script>

    <!-- chart.js and add ons -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js" integrity="sha512-Hn1w6YiiFw6p6S2lXv6yKeqTk0PLVzeCwWY9n32beuPjQ5HLcvz5l2QsP+KilEr1ws37rCTw3bZpvfvVIeTh0Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel ="stylesheet" href ="style.css">

  </head>


  <body>
    <div class="wrapper">
          
      <div class="content-wrapper">
      <nav class="warning">
        <div class="col-wide middle" style=" text-align: center;">
          <p style="margin-bottom: 0px;">This prototype application will be enhanced as further rural data is released.</p>
          <p style="margin-bottom: 0px;">We welcome feedback from users through our 
            <a class="survey-link" href="" target="_blank"><span style="color: white;">short survey</span>
              <img class = "new-tab" src = "img/opens-new-tab.svg"></a></p>
          
          </div>
      </nav>


      <div id="top-container">
        <div id="top-menu" class="grid" style="margin: 0;">
          <div class="logo-container">
            <a href="https://www.nisra.gov.uk/" target="_blank"><img id="top-menu-nisra-logo" src="img/nisra-white-bilingual.svg" alt="NISRA logo. Clicking image takes user to NISRA website"></a>
          </div>
          <div id="dashboard-title-container">
            <h1 id="dashboard-title">Rural Dashboard</h1>
            <span id="dashboard-subtitle">Access urban rural data across a range of <br>areas for Northern Ireland</span>
          </div>
          <div class="logo-container">
              <a href="https://www.daera-ni.gov.uk/" target="_blank"><img id="top-menu-daera-logo" src="img/daera-logo-white.png" alt="DAERA logo. Clicking image takes user to DAERA website"></a>
          </div>
        </div>
      </div>

      <hr style="border-top: 10px solid #076cba; margin: 0">


      <div id="main-container">

        <div id="main-content" class="screen">

            <div class="intro">
              <h2 style="width: 100%; text-align: center;">Select areas on the map below to see Aggregated statstics</h2>
            </div>
            <div class="div-style-bar">
              <div id="map-wrapper">
                <div id="map"></div>
              </div>

            </div>
        

          <div>
            <div id="breakdown-container"></div>
            <br>
            <div id="tables-container"></div>
            <br>
            <h3> Source</h3>
            <p style="margin-bottom: 10px;">Data originally collected and presented in:<br> <a class = "source_name" id="sourceId" target="_blank"></a></p>
            <p> Data presented here has been extracted from the NISRA Data Portal:<br> <a class="dataportal_name" id="portalId" target="_blank"></a></p>
          </div>
          
        <!-- accordion section    -->
          <h3>Notes</h3>
        <button class="accordion-button">Click to expand or hide notes section for <span style="font-weight: bold;" class = "measure_title"></span> by <span style="font-weight: bold; color:#3878c5;"class = "eq_grp_name"></span></button>
          <div class="panel">
            <p id = "measureNotesParagraph" style="margin-bottom: 0px; font-weight: bold;font-size: 18px;">Notes on <span class = "measure_title" style="font-weight: bold;font-size: 18px;"></span></p>
            <p id = "notes_in_measure"></p>
            <p id = "groupNotesParagraph" style="margin-bottom: 0px; font-weight: bold;font-size: 18px;">Notes on <span class = "eq_grp_name" style="font-weight: bold;font-size: 18px;"></span></p>
            <p id = "notes_in_group"></p>
          </div> <!--close panel div-->

        </div> <!--closes main content div-->
      </div>

      </div>
      <hr style="border-top: 10px solid #076cba; margin-bottom: 0; margin-top: 25px;">
      <footer>
        <div id="footer-container">
          <div class="row">
            <div style="height: 170px; width: 350px; margin: 10px;">
              <h3 style="font-weight: 700; font-size: 18px; color: #ffffff">Links</h3>
              <a href="https://data.nisra.gov.uk/" target="_blank" rel="noopener noreferrer">NISRA Data
                Portal</a><br>
              <a href="https://visual.nisra.gov.uk/" target="_blank" rel="noopener noreferrer">NISRA Interactive
                Data Visualisation Hub</a><br>
              <a href="https://www.opendatani.gov.uk/" target="_blank" rel="noopener noreferrer">OpenDataNI</a><br>
              <a href="https://www.nidirect.gov.uk" target="_blank" rel="noopener noreferrer">NIDirect</a><br>
              <a href="https://www.gov.uk/" target="_blank" rel="noopener noreferrer">GOV.UK</a><br>
            </div>
            <div style="height: 170px; width: 120px; margin: 20px 0px 20px 60px;">
              <h3 style="font-weight: 700; font-size: 18px; color: #ffffff">Follow NISRA</h3>
              <i class="fa-brands fa-facebook-f"></i> <a href="https://www.facebook.com/nisra.gov.uk" target="_blank"
                rel="noopener noreferrer">Facebook</a><br>
              <i class="fa-brands fa-x-twitter"></i> <a href="https://twitter.com/NISRA" target="_blank"
                rel="noopener noreferrer">Twitter</a><br>
              <i class="fa-brands fa-youtube"></i> <a href="https://www.youtube.com/user/nisrastats" target="_blank"
                rel="noopener noreferrer">YouTube</a><br>
            </div>
          </div>
          <div class="flex-list-footer">
            <ul
              style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-between; margin-left: -1px;">
              <li class="cc-li" style="border-left:0px;"><a href="https://www.nisra.gov.uk/crown-copyright" target="_blank"
                  rel="noopener noreferrer">Â© Crown Copyright</a></li>
              <!--<li class="cc-li"><a href="https://www.nisra.gov.uk/contacts/programme-government-analytics-executive-office"
                  target="_blank" rel="noopener noreferrer">Contact us</a></li> --> 
              <li class="cc-li"><a href="https://consultations.nidirect.gov.uk/teo/d8cf2dfc" target="_blank">Leave
                  feedback</a></li>
              <li class="cc-li"><a href="https://www.nisra.gov.uk/terms-and-conditions" target="_blank"
                  rel="noopener noreferrer">Terms and conditions</a></li>
              <li class="cc-li"><a href="https://www.nisra.gov.uk/cookies" target="_blank"
                  rel="noopener noreferrer">Cookies</a></li>
              <li class="cc-li"><a href="https://www.nisra.gov.uk/nisra-privacy-notice" target="_blank"
                  rel="noopener noreferrer">Privacy</a></li>
              <li class="cc-li"><a href="https://www.nisra.gov.uk/accessibility-statement-nisra" target="_blank"
                  rel="noopener noreferrer">Accessibility Statement</a></li>
            </ul>
          </div>
        </div>
      </footer>
    </div>
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const map = new maplibregl.Map({
          container: 'map',
          style: 'https://raw.githubusercontent.com/NISRA-Tech-Lab/map_tiles/main/basemap_styles/style-omt.json',
          center: [-6.8, 54.65],
          zoom: 7.5,
          minZoom: 7.5,
          maxZoom: 13,
          maxBounds: [[-9.20, 53.58], [-4.53, 55.72]]
        });

        const selectedIds = new Set();
        let sdzData = {};
        const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });

      fetch('./data.json')
        .then(response => response.json())
        .then(data => {
          sdzData = data["Super Data Zone"] || {};

          map.on('idle', () => {
            const features = map.querySourceFeatures('sdz2021', {
              sourceLayer: 'SDZ2021_clipped'
            });

            features.forEach(feature => {
              const sdzCode = feature.properties.sdz_code;
              const status = sdzData[sdzCode]?.Urban_mixed_rural_status;

              if (status) {
                map.setFeatureState(
                  {
                    source: 'sdz2021',
                    sourceLayer: 'SDZ2021_clipped',
                    id: feature.id
                  },
                  { status: status }
                );
              }
            });
          });
        });

        map.on('load', () => {
          map.addSource('sdz2021', {
            type: 'vector',
            tiles: [
              'https://raw.githubusercontent.com/nisra-explore/map_tiles/main/sdz_2021/{z}/{x}/{y}.pbf'
            ],
            promoteId: { 'SDZ2021_clipped': 'sdz_code' }
          });

          map.addLayer({
            id: 'sdz-fill',
            type: 'fill',
            source: 'sdz2021',
            'source-layer': 'SDZ2021_clipped',
            paint: {
              'fill-color': [
                'case',
                ['boolean', ['feature-state', 'hovered'], false], '#04863e', // Highlight color on click
                ['match', ['feature-state', 'status'],
                  'Rural', '#cccccc',
                  'Urban', '#b04d96',
                  'Mixed', '#4d96b0',
                  '#ffffff' // fallback
                ]
              ],
              'fill-opacity': 0.4
           }
          });

          map.addLayer({
            id: 'sdz-outline-default',
            type: 'line',
            source: 'sdz2021',
            'source-layer': 'SDZ2021_clipped',
            paint: {
              'line-color': '#666666',
              'line-width': 1
            }
          });

          map.addLayer({
            id: 'sdz-outline-hover',
            type: 'line',
            source: 'sdz2021',
            'source-layer': 'SDZ2021_clipped',
            paint: {
              'line-color': [
                'case',
                ['boolean', ['feature-state', 'hovered'], false], '#000000',
                'rgba(0,0,0,0)'
              ],
              'line-width': 2
            }
          });

          map.on('mousemove', 'sdz-fill', (e) => {
            if (!e.features.length) return;

            const feature = e.features[0];
            const id = feature.id;
            const data = sdzData?.[id];

            let popupHtml = '<div><strong>Data not found</strong></div>';
            if (data?.["Census 2021 Super Data Zone Label"]) {
              const labelObj = data["Census 2021 Super Data Zone Label"];
              const zoneName = Object.keys(labelObj)[0];
              popupHtml = `<div><strong>${zoneName}</strong>: ${labelObj[zoneName]}</div>`;
            }

            map.getCanvas().style.cursor = 'pointer';
            popup.setLngLat(e.lngLat).setHTML(popupHtml).addTo(map);
          });

          map.on('mouseleave', 'sdz-fill', () => {
            map.getCanvas().style.cursor = '';
            popup.remove();
          });

          map.on('click', 'sdz-fill', (e) => {
            if (!e.features.length) return;

            const feature = e.features[0];
            const id = feature.id;

            // Toggle selection
            if (selectedIds.has(id)) {
              selectedIds.delete(id);
              map.setFeatureState(
                { source: 'sdz2021', sourceLayer: 'SDZ2021_clipped', id },
                { hovered: false }
              );
            } else {
              selectedIds.add(id);
              map.setFeatureState(
                { source: 'sdz2021', sourceLayer: 'SDZ2021_clipped', id },
                { hovered: true }
              );
            }

            updateTables(Array.from(selectedIds));
          });
        });

        function updateTables(selectedIdsArray) {
          const container = document.getElementById("tables-container");
          container.innerHTML = "";

          const excludedKeys = [
            "Urban_mixed_rural_status",
            "Census 2021 Super Data Zone Label"
          ];

          const aggregatedData = {};
          let totalPopulation = 0;

          selectedIdsArray.forEach(id => {
            const mapData = sdzData[id];
            if (!mapData) return;

            totalPopulation += mapData.population || 0;

            for (const [category, values] of Object.entries(mapData)) {
              if (excludedKeys.includes(category)) continue;
              if (typeof values !== 'object') continue;

              if (!aggregatedData[category]) {
                aggregatedData[category] = {};
              }

              for (const [label, count] of Object.entries(values)) {
                aggregatedData[category][label] = (aggregatedData[category][label] || 0) + count;
              }
            }
          });

          renderZoneBreakdownTable(selectedIdsArray);
          renderAggregatedTables(aggregatedData);

          // update totals 
          document.getElementById("totalPopulation").textContent = totalPopulation;
        }

        function renderZoneBreakdownTable(selectedIdsArray) {
          const container = document.getElementById("breakdown-container");
          container.innerHTML = "";

          if (!selectedIdsArray.length) return;

          let totalPopulation = 0;
          const zoneNames = [];

          selectedIdsArray.forEach(id => {
            const mapData = sdzData[id];
            if (!mapData || !mapData["Census 2021 Super Data Zone Label"]) return;

            const labelObj = mapData["Census 2021 Super Data Zone Label"];
            const zoneName = Object.keys(labelObj)[0];
            const population = labelObj[zoneName];

            totalPopulation += population;
            zoneNames.push(zoneName);
          });

          // Container
          const layout = document.createElement("div");
          layout.className = "summary-row";

          // Left side
          const left = document.createElement("div");
          left.className = "summary-left";
          const leftHeading = document.createElement("h3");
          leftHeading.textContent = "Selected Zones";
          const zoneList = document.createElement("p");
          zoneList.textContent = zoneNames.join(", ");
          left.appendChild(leftHeading);
          left.appendChild(zoneList);

          // Right side
          const right = document.createElement("div");
          right.className = "summary-right";
          const rightHeading = document.createElement("h2");
          rightHeading.textContent = "Total Population:";
          const popValue = document.createElement("h2");
          popValue.textContent = totalPopulation.toLocaleString();
          right.appendChild(rightHeading);
          right.appendChild(popValue);

          layout.appendChild(left);
          layout.appendChild(right);
          container.appendChild(layout);
        }

        function renderAggregatedTables(aggregatedData) {
          const container = document.getElementById("tables-container");
          container.innerHTML = "";

          const entries = Object.entries(aggregatedData);
          const tablesPerRow = 3;

          for (let i = 0; i < entries.length; i += tablesPerRow) {
            const rowDiv = document.createElement("div");
            rowDiv.className = "table-row";
            rowDiv.style.display = "flex";
            rowDiv.style.alignItems = "stretch"; 
            container.appendChild(rowDiv);

            const chunk = entries.slice(i, i + tablesPerRow);
            const tableWrappers = [];

            for (const [category, values] of chunk) {
              const tableContainer = document.createElement("div");
              tableContainer.className = "table-wrapper";
              tableContainer.style.flex = "1";
              tableContainer.style.margin = "0 10px";
              tableContainer.style.display = "flex";
              tableContainer.style.flexDirection = "column";

              const title = document.createElement("h3");
              title.textContent = category;
              title.style.margin = "0 0 8px 0";
              tableContainer.appendChild(title);

              const table = document.createElement("table");
              table.className = "data-table";

              const thead = document.createElement("thead");
              const headerRow = document.createElement("tr");
              ["Category", "Count", "Percentage"].forEach(text => {
                const th = document.createElement("th");
                th.textContent = text;
                headerRow.appendChild(th);
              });
              thead.appendChild(headerRow);
              table.appendChild(thead);

              const tbody = document.createElement("tbody");
              const totalCount = Object.values(values).reduce((acc, val) => acc + val, 0);

              for (const [label, count] of Object.entries(values)) {
                const row = document.createElement("tr");

                const tdLabel = document.createElement("td");
                tdLabel.textContent = label;
                row.appendChild(tdLabel);

                const tdCount = document.createElement("td");
                tdCount.textContent = count;
                row.appendChild(tdCount);

                const tdPercentage = document.createElement("td");
                tdPercentage.textContent = totalCount > 0 ? ((count / totalCount) * 100).toFixed(2) + "%" : "0%";
                row.appendChild(tdPercentage);

                tbody.appendChild(row);
              }

              table.appendChild(tbody);
              tableContainer.appendChild(table);
              rowDiv.appendChild(tableContainer);
              tableWrappers.push(tableContainer);
            }

            // Set equal height for all wrappers in this row
            requestAnimationFrame(() => {
              const maxHeight = Math.max(...tableWrappers.map(wrapper => wrapper.offsetHeight));
              tableWrappers.forEach(wrapper => {
                wrapper.style.height = `${maxHeight}px`;
              });
            });
          }
        }
      });
    </script>
  </body>

</html>

