<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Rural Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="icon" type="image" href="img/favicon-daera.svg">

    <!-- imports for bootstrap - jquery and popper are dependencies -->
    <script src="https://cdn.jsdelivr.net/gh/jquery/jquery@3.4.1/dist/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/twbs/bootstrap@v4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/FezVrasta/popper.js@v1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/twbs/bootstrap@v4.5.2/dist/js/bootstrap.min.js"></script>

    <!-- fontawesome import -->
    <script src="https://kit.fontawesome.com/ee3848f0f5.js" crossorigin="anonymous"></script>

    <!-- chart.js and add ons -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js" integrity="sha512-Hn1w6YiiFw6p6S2lXv6yKeqTk0PLVzeCwWY9n32beuPjQ5HLcvz5l2QsP+KilEr1ws37rCTw3bZpvfvVIeTh0Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel ="stylesheet" href ="style.css">

  </head>


  <body>
    <div class="wrapper">
          
      <div class="content-wrapper">
      <nav class="warning">
        <div class="col-wide middle" style=" text-align: center;">
          <p style="margin-bottom: 0px;">This prototype application will be enhanced as further rural data is released.</p>
          <p style="margin-bottom: 0px;">We welcome feedback from users through our 
            <a class="survey-link" href="" target="_blank"><span style="color: white;">short survey</span>
              <img class = "new-tab" src = "img/opens-new-tab.svg"></a></p>
          
          </div>
      </nav>


      <div id="top-container">
        <div id="top-menu" class="grid" style="margin: 0;">
          <div class="logo-container">
            <a href="https://www.nisra.gov.uk/" target="_blank"><img id="top-menu-nisra-logo" src="img/nisra-white-bilingual.svg" alt="NISRA logo. Clicking image takes user to NISRA website"></a>
          </div>
          <div id="dashboard-title-container">
            <h1 id="dashboard-title">Rural Dashboard</h1>
            <span id="dashboard-subtitle">Access urban rural data across a range of <br>areas for Northern Ireland</span>
          </div>
          <div class="logo-container">
              <a href="https://www.daera-ni.gov.uk/" target="_blank"><img id="top-menu-daera-logo" src="img/daera-logo-white.png" alt="DAERA logo. Clicking image takes user to DAERA website"></a>
          </div>
        </div>
      </div>

      <hr style="border-top: 10px solid #076cba; margin: 0">


      <div id="main-container">

        <div id="main-content" class="screen">

            <div class="intro">
              <h2 style="width: 100%; text-align: center;">Select areas on the map below to see Aggregated statistics</h2>
            </div>
            <div class="button-wrapper">
              <button id="toggle-fill">Toggle Fill</button>
              <button id="urban-rural-btn">Urban-Rural Comparison</button>
            <select id="zone-selector">
              <option value="dz" selected>Data Zone</option>
              <option value="sdz">Super Data Zone</option>
            </select>
              <button id="clear-selection-btn">Clear Selections</button>
            </div>
            <div id="breakdown-container"></div>
            <div class="div-style-bar">
              <div class="map-and-controls">
                
                <div id="category-selector">
                  <h3>Select Categories</h3>
                  <form id="category-form">
                    <label><input type="checkbox" value="Age" checked> Age</label><br>
                    <label><input type="checkbox" value="Sex Label" checked> Sex</label><br>
                    <label><input type="checkbox" value="Religion"> Religion</label><br>
                    <label><input type="checkbox" value="Economic Activity"> Economic Activity</label><br>
                    <label><input type="checkbox" value="Household Composition"> Household Composition</label><br>
                    <label><input type="checkbox" value="Living Arrangements"> Living Arrangements</label><br>
                    <label><input type="checkbox" value="Household Car or Van Availability"> Household Car or Van Availability</label><br>
                    <label><input type="checkbox" value="Qualifications Highest Level"> Qualifications Highest Level</label><br>

                  </form>
                </div>

                <div id="map-wrapper">
                  <div id="map"></div>
                </div>

                <div id="lgd-selector" class="lgd-selector">
                  <h3>Select Local Government District</h3>
                  <div id="lgd-buttons">
                    <button class="lgd-btn" data-lgd="N09000001">Antrim and Newtownabbey</button>
                    <button class="lgd-btn" data-lgd="N09000011">Ards and North Down</button>
                    <button class="lgd-btn" data-lgd="N09000002">Armagh, Banbridge and Craigavon</button>
                    <button class="lgd-btn" data-lgd="N09000003">Belfast</button>
                    <button class="lgd-btn" data-lgd="N09000004">Causeway Coast and Glens</button>
                    <button class="lgd-btn" data-lgd="N09000005">Derry and Strabane</button>
                    <button class="lgd-btn" data-lgd="N09000006">Fermanagh and Omagh</button>
                    <button class="lgd-btn" data-lgd="N09000007">Lisburn and Castlereagh</button>
                    <button class="lgd-btn" data-lgd="N09000008">Mid and East Antrim</button>
                    <button class="lgd-btn" data-lgd="N09000009">Mid Ulster</button>
                    <button class="lgd-btn" data-lgd="N09000010">Newry, Mourne and Down</button>                 
                </div>
                </div>

              </div>

            </div>
        

          <div>
            
            <br>
            <div id="tables-container"></div>
            <div id="urban-rural-comparison"></div>
            <br>
            <div id="charts-container" class="chart-grid" style="margin-top: 30px;"></div>
            <h3> Source</h3>
            <p style="margin-bottom: 10px;">Data originally collected and presented in:<br> <a class = "source_name" id="sourceId" target="_blank"></a></p>
            <p> Data presented here has been extracted from the NISRA Data Portal:<br> <a class="dataportal_name" id="portalId" target="_blank"></a></p>
          </div>
          
        <!-- accordion section    -->
          <h3>Notes</h3>
        <button class="accordion-button">Click to expand or hide notes section for <span style="font-weight: bold;" class = "measure_title"></span> by <span style="font-weight: bold; color:#3878c5;"class = "eq_grp_name"></span></button>
          <div class="panel">
            <p id = "measureNotesParagraph" style="margin-bottom: 0px; font-weight: bold;font-size: 18px;">Notes on <span class = "measure_title" style="font-weight: bold;font-size: 18px;"></span></p>
            <p id = "notes_in_measure"></p>
            <p id = "groupNotesParagraph" style="margin-bottom: 0px; font-weight: bold;font-size: 18px;">Notes on <span class = "eq_grp_name" style="font-weight: bold;font-size: 18px;"></span></p>
            <p id = "notes_in_group"></p>
          </div> <!--close panel div-->

        </div> <!--closes main content div-->
      </div>

      </div>
      <hr style="border-top: 10px solid #076cba; margin-bottom: 0; margin-top: 25px;">
      <footer>
        <div id="footer-container">
          <div class="row">
            <div style="height: 170px; width: 350px; margin: 10px;">
              <h3 style="font-weight: 700; font-size: 18px; color: #ffffff">Links</h3>
              <a href="https://data.nisra.gov.uk/" target="_blank" rel="noopener noreferrer">NISRA Data
                Portal</a><br>
              <a href="https://visual.nisra.gov.uk/" target="_blank" rel="noopener noreferrer">NISRA Interactive
                Data Visualisation Hub</a><br>
              <a href="https://www.opendatani.gov.uk/" target="_blank" rel="noopener noreferrer">OpenDataNI</a><br>
              <a href="https://www.nidirect.gov.uk" target="_blank" rel="noopener noreferrer">NIDirect</a><br>
              <a href="https://www.gov.uk/" target="_blank" rel="noopener noreferrer">GOV.UK</a><br>
            </div>
            <div style="height: 170px; width: 120px; margin: 20px 0px 20px 60px;">
              <h3 style="font-weight: 700; font-size: 18px; color: #ffffff">Follow NISRA</h3>
              <i class="fa-brands fa-facebook-f"></i> <a href="https://www.facebook.com/nisra.gov.uk" target="_blank"
                rel="noopener noreferrer">Facebook</a><br>
              <i class="fa-brands fa-x-twitter"></i> <a href="https://twitter.com/NISRA" target="_blank"
                rel="noopener noreferrer">Twitter</a><br>
              <i class="fa-brands fa-youtube"></i> <a href="https://www.youtube.com/user/nisrastats" target="_blank"
                rel="noopener noreferrer">YouTube</a><br>
            </div>
          </div>
          <div class="flex-list-footer">
            <ul
              style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-between; margin-left: -1px;">
              <li class="cc-li" style="border-left:0px;"><a href="https://www.nisra.gov.uk/crown-copyright" target="_blank"
                  rel="noopener noreferrer">Â© Crown Copyright</a></li>
              <!--<li class="cc-li"><a href="https://www.nisra.gov.uk/contacts/programme-government-analytics-executive-office"
                  target="_blank" rel="noopener noreferrer">Contact us</a></li> --> 
              <li class="cc-li"><a href="https://consultations.nidirect.gov.uk/teo/d8cf2dfc" target="_blank">Leave
                  feedback</a></li>
              <li class="cc-li"><a href="https://www.nisra.gov.uk/terms-and-conditions" target="_blank"
                  rel="noopener noreferrer">Terms and conditions</a></li>
              <li class="cc-li"><a href="https://www.nisra.gov.uk/cookies" target="_blank"
                  rel="noopener noreferrer">Cookies</a></li>
              <li class="cc-li"><a href="https://www.nisra.gov.uk/nisra-privacy-notice" target="_blank"
                  rel="noopener noreferrer">Privacy</a></li>
              <li class="cc-li"><a href="https://www.nisra.gov.uk/accessibility-statement-nisra" target="_blank"
                  rel="noopener noreferrer">Accessibility Statement</a></li>
            </ul>
          </div>
        </div>
      </footer>
    </div>
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const map = new maplibregl.Map({
          container: 'map',
          style: 'https://raw.githubusercontent.com/NISRA-Tech-Lab/map_tiles/main/basemap_styles/style-omt.json',
          center: [-6.8, 54.65],
          zoom: 7.5,
          minZoom: 7.5,
          maxZoom: 13,
          maxBounds: [[-9.20, 53.58], [-4.53, 55.72]]
        });

      // Event listener for choosing SDZ or DZ
      document.getElementById('zone-selector').addEventListener('change', function (e) {
        const selected = e.target.value;

        if (selected === 'sdz') {
          activeZone = 'sdz';
          map.setLayoutProperty('sdz-fill', 'visibility', 'visible');
          map.setLayoutProperty('dz-fill', 'visibility', 'none');
          map.setLayoutProperty('sdz-outline-default', 'visibility', 'visible');
          map.setLayoutProperty('dz-outline-default', 'visibility', 'none');
          map.setLayoutProperty('sdz-outline-hover', 'visibility', 'visible');
          map.setLayoutProperty('dz-outline-hover', 'visibility', 'none');
        } else if (selected === 'dz') {
          activeZone = 'dz';
          map.setLayoutProperty('sdz-fill', 'visibility', 'none');
          map.setLayoutProperty('dz-fill', 'visibility', 'visible');
          map.setLayoutProperty('sdz-outline-default', 'visibility', 'none');
          map.setLayoutProperty('dz-outline-default', 'visibility', 'visible');
          map.setLayoutProperty('sdz-outline-hover', 'visibility', 'none');
          map.setLayoutProperty('dz-outline-hover', 'visibility', 'visible');
        }

        setupZoneEvents(); // rebind interactivity to the correct fill layer

      });

      const selectedIds = new Set();
      let sdzData = {};
      let dzData = {};
      let niTotals = {};
      const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });
      const selectedLGDs = new Set();
        
      fetch('./data.json')
        .then(response => response.json())
        .then(data => {
          sdzData = data["Super Data Zone"] || {};
          dzData = data["Data Zone"] || {};
          niTotals = data["NI Total"] || {};

          map.on('idle', () => {
            // --- Super Data Zone ---
            const sdzFeatures = map.querySourceFeatures('sdz2021', {
              sourceLayer: 'SDZ2021_clipped'
            });

            sdzFeatures.forEach(feature => {
              const sdzCode = feature.properties.sdz_code;
              const status = sdzData[sdzCode]?.Urban_mixed_rural_status;

              if (status) {
                map.setFeatureState(
                  {
                    source: 'sdz2021',
                    sourceLayer: 'SDZ2021_clipped',
                    id: feature.id
                  },
                  { status: status }
                );
              }
            });

            // --- Data Zone ---
            const dzFeatures = map.querySourceFeatures('dz2021', {
              sourceLayer: 'DZ2021_clipped'
            });

            dzFeatures.forEach(feature => {
              const dzCode = feature.properties.dz_code;
              const status = dzData[dzCode]?.Urban_mixed_rural_status;

              if (status) {
                map.setFeatureState(
                  {
                    source: 'dz2021',
                    sourceLayer: 'DZ2021_clipped',
                    id: feature.id
                  },
                  { status: status }
                );
              }
            });
          });
        });
        
        // Function that toggles urban/rural fill based on zone selection
        let fillVisible = true;

        const toggleButton = document.getElementById('toggle-fill');
        const zoneSelector = document.getElementById('zone-selector');

toggleButton.addEventListener('click', () => {
  fillVisible = !fillVisible;
  const selectedZone = zoneSelector.value;
  const layerId = selectedZone === 'dz' ? 'dz-fill' : 'sdz-fill';

  map.setPaintProperty(layerId, 'fill-opacity', [
    'case',
    ['boolean', ['feature-state', 'hovered'], false], 0.4,
    fillVisible ? 0.4 : 0
  ]);

  toggleButton.textContent = fillVisible ? 'Hide Urban/Rural' : 'Show Urban/Rural';
});


      map.on('load', () => {

        map.addSource('sdz2021', {
            type: 'vector',
            tiles: [
              'https://raw.githubusercontent.com/nisra-explore/map_tiles/main/sdz_2021/{z}/{x}/{y}.pbf'
            ],
            promoteId: { 'SDZ2021_clipped': 'sdz_code' }
          });

         map.addSource('dz2021', {
            type: 'vector',
            tiles: [
              'https://raw.githubusercontent.com/nisra-explore/map_tiles/main/dz_2021/{z}/{x}/{y}.pbf'
            ],
            promoteId: { 'DZ2021_clipped': 'dz_code' }
          });

          map.addLayer({
            id: 'sdz-fill',
            type: 'fill',
            source: 'sdz2021',
            'source-layer': 'SDZ2021_clipped',            
            layout: {
              visibility: 'visible'
            },
            paint: {
              'fill-color': [
  'case',
  ['boolean', ['feature-state', 'hovered'], false], '#04863e', // dark green on click
  ['match', ['feature-state', 'status'],
    'Rural', '#cccccc',
    'Urban', '#b04d96',
    'Mixed', '#4d96b0',
    '#ffffff' // fallback
  ]
],
              'fill-opacity': 0.4
           }
          });

         map.addLayer({
            id: 'dz-fill',
            type: 'fill',
            source: 'dz2021',
            'source-layer': 'DZ2021_clipped',            
            layout: {
              visibility: 'visible'
            },
            paint: {
              'fill-color': [
                'case',
                ['boolean', ['feature-state', 'hovered'], false], '#04863e', // dark green on click
                ['match', ['feature-state', 'status'],
                  'Rural', '#cccccc',
                  'Urban', '#b04d96',
                  'Mixed', '#4d96b0',
                  '#ffffff' // fallback
                ]
              ],
              'fill-opacity': 0.4
           }
          });

          map.addLayer({
            id: 'sdz-outline-default',
            type: 'line',
            source: 'sdz2021',
            'source-layer': 'SDZ2021_clipped',
            paint: {
              'line-color': '#666666',
              'line-width': 1
            }
          });

          map.addLayer({
            id: 'dz-outline-default',
            type: 'line',
            source: 'dz2021',
            'source-layer': 'DZ2021_clipped',
            paint: {
              'line-color': '#666666',
              'line-width': 1
            }
          });

          map.addLayer({
            id: 'sdz-outline-hover',
            type: 'line',
            source: 'sdz2021',
            'source-layer': 'SDZ2021_clipped',
            paint: {
              'line-color': [
                'case',
                ['boolean', ['feature-state', 'hovered'], false], '#000000',
                'rgba(0,0,0,0)'
              ],
              'line-width': 2
            }
          });

         map.addLayer({
            id: 'dz-outline-hover',
            type: 'line',
            source: 'dz2021',
            'source-layer': 'DZ2021_clipped',
            paint: {
              'line-color': [
                'case',
                ['boolean', ['feature-state', 'hovered'], false], '#000000',
                'rgba(0,0,0,0)'
              ],
              'line-width': 2
            }
          });

          map.on('mousemove', 'sdz-fill', (e) => {
            if (!e.features.length) return;

            const feature = e.features[0];
            const id = feature.id;
            const data = sdzData?.[id];

            let popupHtml = '<div><strong>Data not found</strong></div>';
            if (data?.["Census 2021 Super Data Zone Label"]) {
              const labelObj = data["Census 2021 Super Data Zone Label"];
              const zoneName = Object.keys(labelObj)[0];
              popupHtml = `<div><strong>${zoneName}</strong>: ${labelObj[zoneName]}</div>`;
            }

            map.getCanvas().style.cursor = 'pointer';
            popup.setLngLat(e.lngLat).setHTML(popupHtml).addTo(map);
          });

         map.on('mousemove', 'dz-fill', (e) => {
            if (!e.features.length) return;

            const feature = e.features[0];
            const id = feature.id;
            const data = dzData?.[id];

            let popupHtml = '<div><strong>Data not found</strong></div>';
            if (data?.["Census 2021 Data Zone Label"]) {
              const labelObj = data["Census 2021 Data Zone Label"];
              const zoneName = Object.keys(labelObj)[0];
              popupHtml = `<div><strong>${zoneName}</strong>: ${labelObj[zoneName]}</div>`;
            }

            map.getCanvas().style.cursor = 'pointer';
            popup.setLngLat(e.lngLat).setHTML(popupHtml).addTo(map);
          });

          map.on('mouseleave', 'sdz-fill', () => {
            map.getCanvas().style.cursor = '';
            popup.remove();
          });

         map.on('mouseleave', 'dz-fill', () => {
            map.getCanvas().style.cursor = '';
            popup.remove();
          });

          map.on('click', 'sdz-fill', (e) => {
            if (!e.features.length) return;

            const feature = e.features[0];
            const id = feature.id;

            const isSelected = selectedIds.has(id);

            if (isSelected) {
              selectedIds.delete(id);
              map.setFeatureState(
                { source: 'sdz2021', sourceLayer: 'SDZ2021_clipped', id },
                { hovered: false }
              );
            } else {
              selectedIds.add(id);
              
              map.setFeatureState(
                { source: 'sdz2021', sourceLayer: 'SDZ2021_clipped', id },
                { hovered: true }
              );
            }

            updateTables(Array.from(selectedIds));
          });

         map.on('click', 'dz-fill', (e) => {
            if (!e.features.length) return;

            const feature = e.features[0];
            const id = feature.id;

            const isSelected = selectedIds.has(id);

            if (isSelected) {
              selectedIds.delete(id);
              map.setFeatureState(
                { source: 'dz2021', sourceLayer: 'DZ2021_clipped', id },
                { hovered: false }
              );
            } else {
              selectedIds.add(id);
              
              map.setFeatureState(
                { source: 'dz2021', sourceLayer: 'DZ2021_clipped', id },
                { hovered: true }
              );
            }

            updateTables(Array.from(selectedIds));
          });

        });

        let latestAggregatedData = {}; 
        let selectedCategories = ['Age', 'Sex Label'];

        document.getElementById("category-form").addEventListener("change", () => {
          selectedCategories = Array.from(document.querySelectorAll('#category-form input:checked'))
            .map(input => input.value);

          const isComparisonVisible = document.getElementById("urban-rural-comparison").style.display !== "none";

          if (isComparisonVisible) {
            renderUrbanRuralComparison(Array.from(selectedIds));
          } else {
            renderAggregatedTables(latestAggregatedData, selectedCategories);
          }
        });
        
      let currentZoneType = 'sdz'; // default
        document.getElementById('zone-selector').addEventListener('change', function () {
          currentZoneType = this.value;
          updateTables(currentSelectedIds); 
       });

      const selector = document.getElementById("zone-selector");

      // Set default value
      selector.value = "dz";

              // Listen for changes
      selector.addEventListener("change", function () {
        currentZoneType = this.value;
        updateTables(currentSelectedIds);
      });


        function updateTables(selectedIdsArray) {
          const container = document.getElementById("tables-container");
          const comparisonDiv = document.getElementById("urban-rural-comparison");

          // Determine view mode
          const isComparisonVisible = comparisonDiv.style.display === "block";

          if (isComparisonVisible) {
            renderUrbanRuralComparison(selectedIdsArray);
            return; // skip standard tables if comparison is active
          }

          // otherwise, proceed with regular table rendering
          container.style.display = "block";
          comparisonDiv.style.display = "none";
          container.innerHTML = "";

          const excludedKeys = [
            "Urban_mixed_rural_status",
            "Census 2021 Super Data Zone Label",
            "Census 2021 Data Zone Label"
          ];
          
          const aggregatedData = {};
          let totalPopulation = 0;

       const dataSource = currentZoneType === 'dz' ? dzData : sdzData;
          
      selectedIdsArray.forEach(id => {
      const mapData = dataSource[id];
      if (!mapData) return;

      totalPopulation += mapData.population || 0;
        
        for (const [category, values] of Object.entries(mapData)) {
        if (excludedKeys.includes(category)) continue;
        if (typeof values !== 'object') continue;

        if (!aggregatedData[category]) {
          aggregatedData[category] = {};
        }
          
        for (const [label, count] of Object.entries(values)) {
         aggregatedData[category][label] = (aggregatedData[category][label] || 0) + count;
        }
       }
     });
    renderZoneBreakdownTable(selectedIdsArray);    
    renderAggregatedCharts(aggregatedData);
    latestAggregatedData = aggregatedData;
    renderAggregatedTables(latestAggregatedData, selectedCategories);
    document.getElementById("totalPopulation").textContent = totalPopulation;
   }

        function renderZoneBreakdownTable(selectedIdsArray) {
          const container = document.getElementById("breakdown-container");

          // Clear and hide if no selections
          if (!selectedIdsArray.length) {
            container.innerHTML = "";
            container.style.display = "none";
            return;
          }
            
          let totalPopulation = 0;
          const zoneNames = [];
          container.innerHTML = "";
          container.style.display = "block"; 
          
          const dataSource = currentZoneType === 'dz' ? dzData : sdzData;
          const labelKey = currentZoneType === 'dz'
            ? "Census 2021 Data Zone Label"
            : "Census 2021 Super Data Zone Label";
          
            selectedIdsArray.forEach(id => {
              const mapData = dataSource[id];
               if (!mapData || !mapData[labelKey]) return;

                const labelObj = mapData[labelKey];
                const zoneName = Object.keys(labelObj)[0];
                const population = labelObj[zoneName];

                totalPopulation += population;
                zoneNames.push(zoneName);
              });

            
          // Build layout
          const layout = document.createElement("div");
          layout.className = "summary-row";
        
           // Left side
          const left = document.createElement("div");
          left.className = "summary-left";
          const leftHeading = document.createElement("h3");
          leftHeading.textContent = "Selected Zones";
          const zoneList = document.createElement("p");
          zoneList.textContent = zoneNames.join(", ");
          left.appendChild(leftHeading);
          left.appendChild(zoneList);

          // Right side
          const right = document.createElement("div");
          right.className = "summary-right";
          const rightHeading = document.createElement("h2");
          rightHeading.textContent = "Total Population:";
          const popValue = document.createElement("h2");
          popValue.textContent = totalPopulation.toLocaleString();
          right.appendChild(rightHeading);
          right.appendChild(popValue);

          layout.appendChild(left);
          layout.appendChild(right);
          container.appendChild(layout);
}


        document.getElementById("urban-rural-btn").addEventListener("click", () => {
          const tablesContainer = document.getElementById("tables-container");
          const comparisonDiv = document.getElementById("urban-rural-comparison");
          const toggleBtn = document.getElementById("urban-rural-btn");

          const isComparisonVisible = comparisonDiv.style.display === "block";

          if (isComparisonVisible) {
            // Show main tables again
            comparisonDiv.style.display = "none";
            tablesContainer.style.display = "block";
            renderAggregatedTables(latestAggregatedData, selectedCategories);

            // Update button label
            toggleBtn.textContent = "Urban Rural Comparison";
          } else {
            // Show comparison view
            tablesContainer.style.display = "none";
            comparisonDiv.style.display = "block";
            renderUrbanRuralComparison(Array.from(selectedIds));

            // Update button label
            toggleBtn.textContent = "View All Data";
          }
        });

        function renderAggregatedTables(aggregatedData, selectedCategories = []) {
          const container = document.getElementById("tables-container");
          container.innerHTML = "";

          const entries = Object.entries(aggregatedData).filter(([key]) => {
            return selectedCategories.length === 0 || selectedCategories.includes(key);
          });

          entries.forEach(([category, values]) => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "table-row";
            rowDiv.style.display = "flex";
            rowDiv.style.marginBottom = "20px";
            rowDiv.style.alignItems = "flex-start";

            // Table container
            const tableContainer = document.createElement("div");
            tableContainer.className = "table-wrapper";
            tableContainer.style.flex = "0 0 33.33%";
            tableContainer.style.marginRight = "10px";

            const title = document.createElement("h3");
            title.textContent = category;
            title.style.margin = "0 0 8px 0";
            tableContainer.appendChild(title);

            const table = document.createElement("table");
            table.className = "data-table";

            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");
            ["Category", "Count", "Percentage", "NI %"].forEach(text => {
              const th = document.createElement("th");
              th.textContent = text;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");
            const totalCount = Object.values(values).reduce((acc, val) => acc + val, 0);

            for (const [label, count] of Object.entries(values)) {
              const row = document.createElement("tr");

              const tdLabel = document.createElement("td");
              tdLabel.textContent = label;
              row.appendChild(tdLabel);

              const tdCount = document.createElement("td");
              tdCount.textContent = count;
              row.appendChild(tdCount);

              const tdPercentage = document.createElement("td");
              tdPercentage.textContent = totalCount > 0 ? ((count / totalCount) * 100).toFixed(2) + "%" : "0%";
              row.appendChild(tdPercentage);

              const tdNI = document.createElement("td");
              const niVal = niTotals[category]?.[label];
              tdNI.textContent = typeof niVal === "number" ? niVal.toFixed(1) + "%" : "â";
              row.appendChild(tdNI);

              tbody.appendChild(row);
            }

            table.appendChild(tbody);
            tableContainer.appendChild(table);

            const chartPlaceholder = document.createElement("div");
            chartPlaceholder.className = "chart-placeholder";
            chartPlaceholder.style.flex = "0 0 66.66%";
            chartPlaceholder.style.height = "100%";
            chartPlaceholder.style.padding = "10px";
            chartPlaceholder.style.background = "#f9f9f9";
            chartPlaceholder.innerHTML = `<p style="text-align:center; color: #888;">[ Chart placeholder for "${category}" ]</p>`;

            rowDiv.appendChild(tableContainer);
            rowDiv.appendChild(chartPlaceholder);
            container.appendChild(rowDiv);
          });
        }
        
Chart.register(ChartDataLabels);

function renderAggregatedCharts(data) {
  const container = document.getElementById("charts-container");
  container.innerHTML = "";
  container.className = "chart-grid";

  const excludedKeys = [
  Â Â Â  "Census 2021 Data Zone Label",
  Â Â Â  "Census 2021 Super Data Zone Label"
  Â  ];

  Â  const entries = Object.entries(data).filter(([key]) => !excludedKeys.includes(key));

  for (const [category, values] of entries) {
    const chartContainer = document.createElement("div");
    chartContainer.className = "chart-wrapper";

    const title = document.createElement("h3");
    title.textContent = category;
    chartContainer.appendChild(title);

    const canvas = document.createElement("canvas");
    chartContainer.appendChild(canvas);
    container.appendChild(chartContainer);

    const labels = Object.keys(values);
    const totalCount = Object.values(values).reduce((acc, val) => acc + val, 0);
    const dataPoints = Object.values(values).map(val =>
      totalCount > 0 ? ((val / totalCount) * 100).toFixed(2) : 0
    );

    new Chart(canvas, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Percentage",
          data: dataPoints,
          backgroundColor: "rgba(0, 0, 139, 0.8)",
          borderColor: "rgba(0, 0, 139, 1)",
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          datalabels: {
            color: '#FFFFFF',
            anchor: 'start',
            align: 'left',
            offset: -50,
            formatter: value => value + '%',
            font: {
              weight: 'bold',
              size: 12
            }
          },
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            title: {
              display: true,
              text: "Percentage"
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }
}

        function clearSelections() {
          selectedIds.forEach(id => {
            if (sdzData[id]) {
              map.setFeatureState(
                { source: 'sdz2021', sourceLayer: 'SDZ2021_clipped', id },
                { hovered: false }
              );
            }
            if (dzData[id]) {
              map.setFeatureState(
                { source: 'dz2021', sourceLayer: 'DZ2021_clipped', id },
                { hovered: false }
              );
            }
          });
          
          selectedIds.clear();
          selectedLGDs.clear();
          popup.remove();

          document.getElementById("tables-container").innerHTML = "";
          document.getElementById("breakdown-container").innerHTML = "";
          document.getElementById("urban-rural-comparison").style.display = "none";
          document.getElementById("tables-container").style.display = "block";

          document.querySelectorAll('.lgd-btn').forEach(btn => btn.classList.remove('selected'));

          const totalPop = document.getElementById("totalPopulation");
          if (totalPop) totalPop.textContent = "0";

          const center = map.getCenter();
          const zoom = map.getZoom();
          map.jumpTo({ center, zoom: zoom + 0.00001 });
     }

document.getElementById("clear-selection-btn").addEventListener("click", function (e) {
  e.preventDefault(); 
  this.blur(); 
  clearSelections(); // <-- This is where it's executed
});

document.querySelectorAll('.lgd-btn').forEach(button => {
  button.addEventListener('click', () => {
    const lgdCode = button.getAttribute('data-lgd');
    const isSelected = selectedLGDs.has(lgdCode);

    if (isSelected) {
      selectedLGDs.delete(lgdCode);
      button.classList.remove('selected');

      // Remove zones from selectedIds
      const toRemove = Array.from(selectedIds).filter(id => {
        const data = currentZoneType === 'dz' ? dzData[id] : sdzData[id];
        return data?.LGD === lgdCode;
      });

      toRemove.forEach(id => {
        selectedIds.delete(id);
        const source = currentZoneType === 'dz' ? 'dz2021' : 'sdz2021';
        const sourceLayer = currentZoneType === 'dz' ? 'DZ2021_clipped' : 'SDZ2021_clipped';
        map.setFeatureState({ source, sourceLayer, id }, { hovered: false });
      });

    } else {
      selectedLGDs.add(lgdCode);
      button.classList.add('selected');

      // Add zones to selectedIds
      const dataSource = currentZoneType === 'dz' ? dzData : sdzData;
      const newIds = Object.entries(dataSource)
        .filter(([id, data]) => data?.LGD === lgdCode)
        .map(([id]) => id);

      newIds.forEach(id => {
        if (!selectedIds.has(id)) {
          selectedIds.add(id);
          const source = currentZoneType === 'dz' ? 'dz2021' : 'sdz2021';
          const sourceLayer = currentZoneType === 'dz' ? 'DZ2021_clipped' : 'SDZ2021_clipped';
          map.setFeatureState({ source, sourceLayer, id }, { hovered: true });
        
          
        }
      });
    }
    
     const selectedArray = Array.from(selectedIds);
            updateTables(selectedArray);
            renderZoneBreakdownTable(selectedArray); 
    
      });
});

        function renderUrbanRuralComparison(selectedIdsArray) {
          const container = document.getElementById("urban-rural-comparison");
          container.innerHTML = "";

          const excludedKeys = ["Urban_mixed_rural_status", "Census 2021 Super Data Zone Label", "LGD"];
          const groups = { Urban: {}, Rural: {}, Mixed: {} };
          const zoneLabels = { Urban: [], Rural: [], Mixed: [] };

          selectedIdsArray.forEach(id => {
            const data = sdzData[id];
            if (!data || !["Urban", "Rural", "Mixed"].includes(data.Urban_mixed_rural_status)) return;

            const group = data.Urban_mixed_rural_status;
            const labelObj = data["Census 2021 Super Data Zone Label"];
            const zoneName = labelObj ? Object.keys(labelObj)[0] : null;
            if (zoneName) zoneLabels[group].push(zoneName);

            for (const [category, values] of Object.entries(data)) {
              if (excludedKeys.includes(category) || typeof values !== 'object') continue;

              if (!groups[group][category]) groups[group][category] = {};
              for (const [label, count] of Object.entries(values)) {
                groups[group][category][label] = (groups[group][category][label] || 0) + count;
              }
            }
          });

          const categoriesToDisplay = selectedCategories.length ? selectedCategories : Object.keys(groups.Urban).concat(Object.keys(groups.Rural));

          categoriesToDisplay.forEach(category => {
            if (!groups.Urban[category] && !groups.Rural[category]) return;

            const rowDiv = document.createElement("div");
            rowDiv.className = "table-row";
            rowDiv.style.display = "flex";
            rowDiv.style.marginBottom = "20px";
            rowDiv.style.gap = "2rem";

            ["Urban", "Rural", "Mixed"].forEach(groupType => {
              if (!groups[groupType][category]) return;

              const wrapper = document.createElement("div");
              wrapper.className = "table-wrapper";
              wrapper.style.flex = "1";

              const title = document.createElement("h3");
              title.textContent = `${groupType} â ${category}`;
              wrapper.appendChild(title);

              const subtitle = document.createElement("h4");
              subtitle.style.fontWeight = "normal";
              subtitle.style.fontSize = "14px";
              subtitle.style.color = "#666";
              subtitle.textContent = "Zones: " + (zoneLabels[groupType].length > 0 ? zoneLabels[groupType].join(", ") : "None selected");
              wrapper.appendChild(subtitle);

              const values = groups[groupType][category];
              const totalCount = Object.values(values).reduce((sum, val) => sum + val, 0);

              const table = document.createElement("table");
              table.className = "data-table";

              const thead = document.createElement("thead");
              const header = document.createElement("tr");
              ["Category", "Count", "Percentage", "NI %"].forEach(text => {
                const th = document.createElement("th");
                th.textContent = text;
                header.appendChild(th);
              });
              thead.appendChild(header);
              table.appendChild(thead);

              const tbody = document.createElement("tbody");

              for (const [label, count] of Object.entries(values)) {
                const row = document.createElement("tr");

                const tdLabel = document.createElement("td");
                tdLabel.textContent = label;
                row.appendChild(tdLabel);

                const tdCount = document.createElement("td");
                tdCount.textContent = count;
                row.appendChild(tdCount);

                const tdPercentage = document.createElement("td");
                tdPercentage.textContent = totalCount ? ((count / totalCount) * 100).toFixed(2) + "%" : "0%";
                row.appendChild(tdPercentage);

                const tdNI = document.createElement("td");
                const niVal = niTotals[category]?.[label];
                tdNI.textContent = typeof niVal === "number" ? niVal.toFixed(1) + "%" : "â";
                row.appendChild(tdNI);

                tbody.appendChild(row);
              }

              table.appendChild(tbody);
              wrapper.appendChild(table);
              rowDiv.appendChild(wrapper);
            });

            container.appendChild(rowDiv);

            requestAnimationFrame(() => {
              const wrappers = rowDiv.querySelectorAll('.table-wrapper');
              const maxHeight = Math.max(...Array.from(wrappers).map(w => w.offsetHeight));
              wrappers.forEach(w => w.style.height = `${maxHeight}px`);
            });
          });
        }

      });
    </script>
  </body>

</html>
